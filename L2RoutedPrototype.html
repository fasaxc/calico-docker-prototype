<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<title>L2RoutedPrototype.html</title>

</head>

<body>

<h1>L2 Routed Docker Prototype</h1>

<p>This prototype demonstrates Calico running in a docker environment
with L2 routed compute hosts. It comprises steps for the following.</p>

<ul>
<li>Installing and configuring Calico and the required components.</li>
<li>Creating and networking containers.</li>
<li>Verifying connectivity between containers.</li>
</ul>

<h2>How to install and run it.</h2>

<p>You'll need the following.</p>

<ul>
<li><p>Two servers with IP addresses that you'll need to update in a number
of places (listed in the bullet points below).  (You can add further
servers, but it requires extra changes to the config files that is
not documented in detail here.)</p></li>
<li><p>A working OS on the servers, with docker installed.  Any flavour of
Linux is likely to work, subject to providing at least version 1.2
of docker (and we recommend using at least version 1.3), but we have
tested recently on CoreOS and Ubuntu Trusty (14.04).</p>

<p>On Ubuntu Trusty, the following instructions got Docker 1.3
installed:</p>

<pre><code>sudo apt-add-repository ppa:james-page/docker
sudo apt-get update
sudo apt-get install docker.io
</code></pre></li>
<li><p>ipset installed, on each server.  For example, on Ubuntu:</p>

<pre><code>sudo apt-get install ipset
</code></pre></li>
</ul>

<p><em>All commands from here on assume that you are running as root.</em></p>

<p><a id="setup"></a></p>

<h4>Setup and installation</h4>

<ol>
<li><p>Copy the whole of this git repository to both host servers as
<code>/opt/demo</code> (the location isn't important, except in so far as it is
used in the instructions).</p></li>
<li><p>Edit the IP addresses for the servers. These need to change in
various places.</p>

<ul>
<li><p><code>felix.txt</code> at the root of the repository, which must have both
IP addresses and hostnames. The hostnames in the example are
<code>instance-1</code> and <code>instance-2</code>; these must match the hostnames
returned by <code>hostname</code> on your compute hosts.</p></li>
<li><p>The Dockerfiles under the directory <code>felix</code> needs to have the IP
addresses changed.</p></li>
<li><p>The Dockerfile under the directory <code>bird</code> needs to have the IP
addresses changed.</p></li>
</ul>

<p>If your code is in <code>/opt/demo</code>, and the two IP addresses in use
are <code>1.2.3.4</code> and <code>2.3.4.5</code>, using hostname <code>host_1</code> and <code>host_2</code>,
then the following commands will do it.</p>

<pre><code>    IP1=1.2.3.4
    IP2=2.3.4.5
    HOST1=host_1
    HOST2=host_2
    for file in /opt/demo/felix.txt /opt/demo/felix/Dockerfile /opt/demo/bird/Dockerfile;
    do
      sed -i "s/IP1/$IP1/" $file
      sed -i "s/IP2/$IP2/" $file
      sed -i "s/HOST1/$HOST1/" $file
      sed -i "s/HOST2/$HOST2/" $file
    done
</code></pre></li>
<li><p>The BIRD configuration assumes that you are willing to assign
container addresses in the <code>192.168.0.0/16</code> range; if for some reason
you need to use another range, you'll need to edit <code>bird.conf</code> in the
(hopefully) obvious way.</p></li>
<li><p>Build the four docker images, by executing the commands below. The
fourth image is just a utility image that contains tools such as
<code>wget</code>, <code>telnet</code> and <code>traceroute</code> - making testing connectivity easier -
while the others contain real useful function.</p>

<pre><code>docker build -t "calico:bird" /opt/demo/bird 
docker build -t "calico:plugin" /opt/demo/plugin
docker build -t "calico:felix" /opt/demo/felix
docker build -t "calico:util" /opt/demo/util
</code></pre>

<p><a id="restart"></a></p></li>
<li><p>On each host, run the following commands (as root).</p>

<pre><code>modprobe ip6_tables
modprobe xt_set
mkdir /var/log/calico
mkdir /var/run/netns
mkdir -p /opt/plugin/data
</code></pre></li>
<li><p>Copy the base config file with information about Felix and the ACL
manager (recall that you edited this above). You only need to run this
command on the first host.</p>

<pre><code>cp /opt/demo/felix.txt /opt/plugin/data
</code></pre></li>
</ol>

<h4>Start the containers</h4>

<ol>
<li><p>On the first host, start BIRD and the plugins.  Two instances are
run, one for the network API and one for the Endpoint API.  If you
want more diagnostics, run them interactively from a bash container.
<em>The plugins must run on the first server only.</em></p>

<pre><code>docker run -d -v /var/log/bird:/var/log/bird --privileged=true --name="bird" --net=host --restart=always -t calico:bird /usr/bin/run_bird bird1.conf
docker run -d -v /var/log/calico:/var/log/calico --privileged=true --name="plugin1" --net=host --restart=always -v /opt/plugin:/opt/plugin calico:plugin python /opt/scripts/plugin.py network
docker run -d -v /var/log/calico:/var/log/calico --privileged=true --name="plugin2" --net=host --restart=always -v /opt/plugin:/opt/plugin calico:plugin python /opt/scripts/plugin.py ep
</code></pre>

<p>The plugins would normally be the part of the orchestration that
informs the Calico components about the current state of the
system.  In this prototype the plugins are simple python script
that load text config (which you will create shortly).  <em>Note that
the plugins and Felix poll for configuration - this is just a
limitation of the prototype code, and means that there may be a
delay of some seconds before endpoints are fully networked.</em></p></li>
<li><p>On the first host, run the following as root (to start Felix and
the ACL Manager).</p>

<pre><code>docker run -d -v /var/log/calico:/var/log/calico --privileged=true --name="felix" --net=host --restart=always -t calico:felix calico-felix --config-file=/etc/calico/felix.cfg
docker run -d -v /var/log/calico:/var/log/calico --privileged=true --name="aclmgr" --net=host --restart=always -t calico:felix calico-acl-manager --config-file=/etc/calico/acl_manager.cfg
</code></pre></li>
<li><p>On the second (and any further) hosts, run the following to start
Felix and BIRD.  (ACL Manager need only run on the first host, so is
not started here.)</p>

<pre><code>docker run -d -v /var/log/calico:/var/log/calico --privileged=true --name="felix" --net=host --restart=always -t calico:felix calico-felix --config-file=/etc/calico/felix.cfg
docker run -d -v /var/log/bird:/var/log/bird --privileged=true --name="bird" --net=host --restart=always -t calico:bird /usr/bin/run_bird bird2.conf
</code></pre></li>
</ol>

<h4>Create some configuration for Felix</h4>

<p>Next create some containers, and network them. The simplest way of
doing this is as follows.</p>

<ul>
<li><p>Create the container with a command something like</p>

<pre><code>docker run -i -t --net=none --name=192_168_1_1 calico:util
</code></pre>

<p>The name here is deliberately intended to be the IP address;
picking sensible names makes it far simpler to keep track. <em>This
creates an interactive container - so you'll need to keep creating
ssh sessions for each container you create.</em></p></li>
<li><p>Now network the container. This would normally be done by the
orchestration, but in this demo it is done by a shell script. Sample
usage is as follows (as root).</p>

<pre><code>bash /opt/demo/network_container.sh CID IP GROUP
</code></pre>

<p>Here:</p>

<ul>
<li><p><code>CID</code> is the container ID as reported on the command line from
<code>docker ps</code> (or from <code>docker run</code>).</p></li>
<li><p><code>IP</code> is the IP address to assign.</p></li>
<li><p><code>GROUP</code> is the name of the group. In this prototype, each
endpoint is in a single group, and the other endpoints only have
access to it if they are in the same group. Names are arbitrary.</p></li>
</ul></li>
<li><p>If you networked a container on the first host, then you are done -
the script creates files in <code>/opt/plugin/data</code>, then <code>cat</code>s everything
in that directory to <code>/opt/plugin/data.txt</code> where the plugin reads
is. If you networked a container on the second host, then you need to
copy across the relevant container config file into <code>/opt/plugin/data</code>
and manually recreate <code>/opt/plugin/data.txt</code>. On the first host, this
involves something like the following commands.</p>

<pre><code>scp host2:/opt/plugin/data/192_168_1_1.txt /opt/plugin/data
cat /opt/plugin/data/*.txt &gt; /opt/plugin/data.txt
</code></pre></li>
<li><p>The plugin checks for configuration dynamically, but it might take
quite some time (up to a minute or two) before it notices and passes
through changes to Calico.</p></li>
<li><p>Finally, you may want to delete one of the containers that you have
created. Just exiting from the shell will get rid of the container (and hence
the interface and routes); however, there will still be some resources created
by Felix (such as the <code>iptables</code> rules and <code>ipsets</code>) left around. To remove
these, remove the relevant text file from the first host. For example :</p>

<pre><code>rm /opt/plugin/data/192_168_1_1.txt
cat /opt/plugin/data/*.txt &gt; /opt/plugin/data.txt
</code></pre>

<p>If the plugin is on the second host, you should run the <code>rm</code> command in both places to avoid confusion (though the plugin only reads from the first host).</p></li>
</ul>

<h2>Verifying that it works</h2>

<p>Naturally, you'll want to check that it's doing what you expect. Good
things to look at include the following.</p>

<ul>
<li><p><code>ip route</code> shows you the routes on the servers. There should be one
for each virtual interface (on both servers).</p></li>
<li><p><code>iptables</code> shows a whole range of rules controlling traffic.</p></li>
<li><p>Verify that you can ping and telnet between the containers that you
created above, if and only if you specified the same group name for
them.</p></li>
</ul>

<h2>Troubleshooting</h2>

<h3>Basic checks</h3>

<p>If things do go wrong (and it can be a little fiddly setting it up),
then here are some good initial debug steps.</p>

<ol>
<li><p>Are all of the containers running on the first host?</p>

<ul>
<li><code>plugin1</code></li>
<li><code>plugin2</code></li>
<li><code>felix</code></li>
<li><code>aclmgr</code></li>
<li><code>bird</code></li>
</ul>

<p>All of these should restart on failure, so not running is probably a configuration error.</p></li>
<li><p>Are all of the containers running on the first host?</p>

<ul>
<li><code>felix</code></li>
<li><code>bird</code></li>
</ul>

<p>Again, these should restart on failure.</p></li>
<li><p>If you have rebooted your hosts, then some configuration gets lost. Rerun the instructions from <a href="#restart">here</a>
to make sure that they are all in a good state.</p></li>
<li><p>Did you do all of the IP addresses and hostnames correctly in the various files? It's worth rechecking all of the steps in <a href="#setup">the whole setup section</a> again.</p></li>
</ol>

<h3>Logging and diagnostics</h3>

<ul>
<li><p>Logs from Felix and the ACL Manager are in <code>/var/log/calico/</code>.</p></li>
<li><p>The plugin logs are also in <code>/var/log/calico/</code>.</p></li>
<li><p>BIRD has its own logging too, and logs are sent to <code>/var/log/bird</code>.</p></li>
</ul>

</body>
</html>
